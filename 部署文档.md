# 肿瘤治疗进展查询系统 - 部署文档

## 目录

1. [系统要求](#系统要求)
2. [服务器配置](#服务器配置)
3. [部署步骤](#部署步骤)
4. [配置说明](#配置说明)
5. [监控和维护](#监控和维护)
6. [备份和恢复](#备份和恢复)
7. [故障排除](#故障排除)

## 系统要求

### 最小配置（支持100-500并发用户）

- **CPU**: 4核心 2.4GHz+
- **内存**: 8GB RAM
- **存储**: 100GB SSD（系统+数据）
- **网络**: 100Mbps带宽
- **操作系统**: Ubuntu 20.04 LTS / CentOS 7+

### 推荐配置（支持500-2000并发用户）

- **CPU**: 8核心 2.4GHz+
- **内存**: 16GB RAM
- **存储**: 200GB SSD（系统+数据）
- **网络**: 1Gbps带宽
- **操作系统**: Ubuntu 22.04 LTS / CentOS 8+

### 软件依赖

- **Docker**: 20.10+
- **Docker Compose**: 2.0+
- **Git**: 2.20+

## 服务器配置

### 1. 系统初始化

```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装必要工具
sudo apt install -y curl wget git vim htop net-tools

# 配置时区
sudo timedatectl set-timezone Asia/Shanghai

# 配置主机名
sudo hostnamectl set-hostname oncology-server
```

### 2. 安装Docker

```bash
# 卸载旧版本
sudo apt remove docker docker-engine docker.io containerd runc

# 安装Docker
sudo apt install -y ca-certificates gnupg lsb-release
sudo mkdir -p /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg

echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

sudo apt update
sudo apt install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin

# 配置用户权限
sudo usermod -aG docker $USER
```

### 3. 安装Docker Compose

```bash
# 下载Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose

# 添加执行权限
sudo chmod +x /usr/local/bin/docker-compose

# 验证安装
docker-compose --version
```

### 4. 系统优化

```bash
# 配置内核参数
echo 'net.core.somaxconn = 65535' | sudo tee -a /etc/sysctl.conf
echo 'net.ipv4.tcp_max_syn_backlog = 65535' | sudo tee -a /etc/sysctl.conf
echo 'vm.max_map_count = 262144' | sudo tee -a /etc/sysctl.conf
sudo sysctl -p

# 配置limits
echo '* soft nofile 65535' | sudo tee -a /etc/security/limits.conf
echo '* hard nofile 65535' | sudo tee -a /etc/security/limits.conf
echo '* soft nproc 4096' | sudo tee -a /etc/security/limits.conf
echo '* hard nproc 4096' | sudo tee -a /etc/security/limits.conf
```

## 部署步骤

### 1. 获取代码

```bash
# 克隆代码仓库
git clone <repository-url>
cd oncology-trials-system
```

### 2. 配置环境变量

```bash
# 创建环境变量文件
cp .env.example .env

# 编辑环境变量
vim .env
```

**环境变量配置示例：**

```bash
# 应用配置
APP_NAME=肿瘤治疗进展查询系统
APP_VERSION=1.0.0
ENVIRONMENT=production
DEBUG=false

# 数据库配置
DB_HOST=postgres
DB_PORT=5432
DB_NAME=oncology_db
DB_USER=oncology_user
DB_PASSWORD=your_strong_password

# Redis配置
REDIS_HOST=redis
REDIS_PORT=6379
REDIS_PASSWORD=

# Elasticsearch配置
ELASTICSEARCH_URL=http://elasticsearch:9200

# JWT配置
JWT_SECRET_KEY=your_256_bit_secret_key_here
ACCESS_TOKEN_EXPIRE_MINUTES=480

# 安全配置
PASSWORD_MIN_LENGTH=8
MAX_LOGIN_ATTEMPTS=5

# 外部API配置
CLINICALTRIALS_API_URL=https://clinicaltrials.gov/api/v2
PUBMED_API_URL=https://eutils.ncbi.nlm.nih.gov/entrez/eutils

# 监控配置
GRAFANA_PASSWORD=your_grafana_password
```

### 3. 构建和启动服务

```bash
# 进入部署目录
cd deploy

# 创建必要的目录
mkdir -p logs ssl

# 启动服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f
```

### 4. 初始化数据库

```bash
# 进入后端容器
docker-compose exec backend bash

# 执行数据库初始化
alembic upgrade head

# 创建超级用户
python -m app.cli create-superuser --username admin --email admin@example.com
```

### 5. 配置SSL证书（生产环境）

```bash
# 使用Let's Encrypt获取SSL证书
sudo apt install -y certbot

# 获取证书
sudo certbot certonly --standalone -d your-domain.com

# 复制证书到部署目录
sudo cp /etc/letsencrypt/live/your-domain.com/fullchain.pem ./ssl/cert.pem
sudo cp /etc/letsencrypt/live/your-domain.com/privkey.pem ./ssl/key.pem

# 修改Nginx配置启用SSL
# 编辑 deploy/nginx.conf，取消SSL相关配置的注释

# 重启服务
docker-compose restart frontend
```

## 配置说明

### 1. 数据库配置

- **PostgreSQL**: 主数据库，存储所有业务数据
- **Redis**: 缓存数据库，存储热点数据和会话信息
- **Elasticsearch**: 搜索引擎，提供全文搜索功能

### 2. 服务配置

- **Frontend**: Nginx + Vue.js应用，处理静态资源
- **Backend**: FastAPI应用，提供API服务
- **Celery**: 异步任务处理，用于数据同步
- **Prometheus**: 指标收集和监控
- **Grafana**: 数据可视化展示

### 3. 网络配置

- **Frontend**: 80/443端口（HTTP/HTTPS）
- **Backend**: 8000端口（API服务）
- **Prometheus**: 9090端口（内部监控）
- **Grafana**: 3000端口（监控面板）

## 监控和维护

### 1. 查看服务状态

```bash
# 查看所有服务状态
docker-compose ps

# 查看服务日志
docker-compose logs -f backend
docker-compose logs -f frontend
docker-compose logs -f postgres

# 查看资源使用情况
docker stats
```

### 2. 性能监控

- **访问 Grafana**: `http://your-server-ip:3000`
- **默认用户**: admin
- **默认密码**: 在环境变量中配置

### 3. 日志管理

```bash
# 查看实时日志
docker-compose logs -f

# 查看特定服务的日志
docker-compose logs -f backend

# 查看特定时间段的日志
docker-compose logs --since 1h backend

# 导出日志
docker-compose logs backend > backend.log
```

### 4. 资源监控

```bash
# 查看系统资源
htop

# 查看磁盘使用
df -h

# 查看内存使用
free -h

# 查看网络连接
netstat -tuln
```

## 备份和恢复

### 1. 数据库备份

```bash
# 创建备份脚本
vim backup-database.sh
```

```bash
#!/bin/bash
# 数据库备份脚本

BACKUP_DIR="/backup/database"
DATE=$(date +%Y%m%d_%H%M%S)
CONTAINER_NAME="oncology-postgres"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 执行备份
docker exec $CONTAINER_NAME pg_dump -U oncology_user oncology_db > $BACKUP_DIR/backup_$DATE.sql

# 压缩备份文件
gzip $BACKUP_DIR/backup_$DATE.sql

# 删除7天前的备份
find $BACKUP_DIR -name "backup_*.sql.gz" -mtime +7 -delete

echo "数据库备份完成: backup_$DATE.sql.gz"
```

```bash
# 添加执行权限
chmod +x backup-database.sh

# 添加到定时任务
crontab -e
# 添加以下行，每天凌晨2点备份
0 2 * * * /path/to/backup-database.sh
```

### 2. 数据恢复

```bash
# 恢复数据库
docker exec -i oncology-postgres psql -U oncology_user oncology_db < backup_file.sql
```

### 3. 文件备份

```bash
# 备份用户上传文件
tar -czf user_files_backup.tar.gz /path/to/user/files/
```

## 故障排除

### 1. 服务无法启动

```bash
# 检查日志
docker-compose logs backend

# 检查端口占用
netstat -tuln | grep 8000

# 重启服务
docker-compose restart backend
```

### 2. 数据库连接失败

```bash
# 检查数据库状态
docker-compose ps postgres

# 检查数据库日志
docker-compose logs postgres

# 测试数据库连接
docker-compose exec postgres pg_isready -U oncology_user
```

### 3. 性能问题

```bash
# 查看系统资源
htop

# 查看容器资源使用
docker stats

# 查看数据库慢查询
# 在PostgreSQL中执行
SELECT * FROM pg_stat_statements ORDER BY total_time DESC LIMIT 10;
```

### 4. 内存不足

```bash
# 查看内存使用
free -h

# 清理缓存
sudo sync && sudo echo 3 > /proc/sys/vm/drop_caches

# 增加交换空间
sudo fallocate -l 4G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
```

### 5. 磁盘空间不足

```bash
# 查看磁盘使用
df -h

# 清理Docker日志
docker system prune -a

# 清理系统日志
sudo journalctl --vacuum-time=7d

# 清理临时文件
sudo rm -rf /tmp/*
```

## 常见问题

### Q1: 如何更新系统？

```bash
# 拉取最新代码
git pull origin main

# 重新构建和启动
docker-compose down
docker-compose build
docker-compose up -d
```

### Q2: 如何扩容？

```bash
# 水平扩展后端服务
docker-compose up --scale backend=3 -d

# 配置负载均衡（需要修改nginx配置）
```

### Q3: 如何监控API性能？

```bash
# 查看API响应时间
docker-compose logs backend | grep "duration"

# 使用Prometheus和Grafana监控
# 访问 http://your-server:3000
```

### Q4: 如何配置邮件通知？

```bash
# 在.env中添加邮件配置
EMAIL_HOST=smtp.example.com
EMAIL_PORT=587
EMAIL_USER=your-email@example.com
EMAIL_PASSWORD=your-password
```

### Q5: 如何备份Elasticsearch数据？

```bash
# 创建Elasticsearch快照
# 参考: https://www.elastic.co/guide/en/elasticsearch/reference/current/snapshots-take-snapshot.html
```

## 技术支持

如有问题，请联系技术支持团队：

- **邮箱**: support@oncology-trials.com
- **电话**: +86 400-123-4567
- **文档**: https://docs.oncology-trials.com
- **GitHub**: https://github.com/oncology-trials/system

---

**文档版本**: 1.0  
**更新日期**: 2025-12-30  
**维护团队**: 技术开发部